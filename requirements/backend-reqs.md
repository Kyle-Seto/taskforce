# Backend Details: MMO RPG Daily Tasks Web App

## Project Overview
This document outlines the backend architecture and implementation details for the MMO RPG daily tasks web application, with a focus on team-based gameplay and team-specific leaderboards.

## Technology Stack
- Next.js 14 (API Routes for serverless functions)
- Supabase (PostgreSQL database)
- Clerk (Authentication)

## Database Schema (Supabase)

1. Users Table
   - id (primary key, generated by Clerk)
   - username
   - email
   - xp
   - level
   - total_damage_dealt

2. Teams Table
   - id (primary key)
   - name
   - admin_id (foreign key to Users)
   - current_boss_id (foreign key to Bosses)

3. TeamMembers Table
   - id (primary key)
   - team_id (foreign key to Teams)
   - user_id (foreign key to Users)

4. Tasks Table
   - id (primary key)
   - team_id (foreign key to Teams)
   - assigned_to (foreign key to Users)
   - description
   - xp_reward
   - date
   - is_completed (boolean)

5. Bosses Table
   - id (primary key)
   - name
   - image_url
   - max_hp
   - current_hp
   - xp_reward


## API Endpoints

Implement the following API routes using Next.js API Routes:

1. User Management
   - GET /api/users/:id
   - PUT /api/users/:id (update XP, level)

2. Team Management
   - POST /api/teams (create team)
   - GET /api/teams/:id
   - PUT /api/teams/:id (update team)
   - DELETE /api/teams/:id
   - POST /api/teams/:id/invite (invite user to team)
   - GET /api/teams/:id/members (get team members)

3. Task Management
   - POST /api/tasks (create task)
   - GET /api/tasks/:teamId (get tasks for a team)
   - PUT /api/tasks/:id (update task, mark as completed)
   - DELETE /api/tasks/:id

4. Boss Management
   - GET /api/bosses/:teamId (get current boss for a team)
   - POST /api/bosses/:teamId (create new boss for a team)
   - PUT /api/bosses/:id (update boss HP)

5. Leaderboard
   - GET /api/leaderboard/:teamId/damage
   - GET /api/leaderboard/:teamId/tasks

## Authentication and Authorization

- Utilize Clerk for user authentication
- Implement middleware to verify user sessions and permissions
- Ensure that only team admins can create tasks and invite users

## Data Processing

1. Daily Task Reset
   - Implement a scheduled function (e.g., using Vercel Cron Jobs) to reset tasks daily

2. XP and Leveling System
   - Calculate and update user XP upon task completion
   - Implement leveling logic based on XP thresholds

3. Boss Battles
   - Calculate damage dealt to bosses based on completed tasks and user levels
   - Generate new bosses when the current one is defeated
   - Distribute XP rewards to team members upon boss defeat
   - Update UserDamage table to track individual contributions

## Security Considerations

1. Input Validation
   - Implement thorough input validation for all API endpoints
   - Use a validation library like Zod for request payload validation

2. Rate Limiting
   - Implement rate limiting on API routes to prevent abuse

3. Error Handling
   - Create a consistent error handling mechanism
   - Avoid exposing sensitive information in error messages

4. Environment Variables
   - Store all sensitive information (API keys, database credentials) as environment variables
   - Ensure environment variables are properly set in the deployment environment

5. CORS Configuration
   - Configure CORS settings to allow requests only from your frontend domain

## Performance Optimization

1. Database Indexing
   - Create appropriate indexes on frequently queried columns, especially for team-specific queries

2. Caching
   - Implement caching for frequently accessed data (e.g., team leaderboards) using Vercel's Edge Cache or a similar solution

3. Pagination
   - Implement pagination for API endpoints that might return large datasets, such as team member lists or task lists

## Monitoring and Logging

1. Error Tracking
   - Integrate an error tracking service (e.g., Sentry) for monitoring runtime errors

2. Logging
   - Implement structured logging for important events and errors

3. Performance Monitoring
   - Set up performance monitoring to track API response times and database query performance

## Deployment

1. Vercel Deployment
   - Configure your Next.js application for deployment on Vercel
   - Set up environment variables in the Vercel dashboard

2. Database Migration
   - Create and manage database migrations for Supabase

3. CI/CD
   - Set up a CI/CD pipeline for automated testing and deployment

## Team-Specific Considerations

1. Team Switching
   - Implement efficient querying for user's teams to populate the team dropdown
   - Ensure all data fetching is scoped to the currently selected team

2. Team Leaderboards
   - Optimize queries for team-specific leaderboards
   - Implement separate endpoints for damage dealt and task completion leaderboards

3. Boss State Management
   - Ensure boss state is properly managed and updated for each team independently

Remember to keep your API keys, database credentials, and other sensitive information secure. Never commit these directly to your version control system.